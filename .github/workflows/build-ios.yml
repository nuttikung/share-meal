name: Build and Sign iOS App

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

    - name: Install cargo-binstall
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

    - name: Install Dioxus CLI
      run: cargo binstall dioxus-cli

    - name: Build unsigned iOS bundle
      run: dx bundle --platform ios
      working-directory: .

    - name: Decode certificate
      run: echo "${{ secrets.IOS_CERTIFICATE }}" | base64 -d > certificate.p12

    - name: Decode provisioning profile
      run: echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 -d > profile.mobileprovision

    - name: Import certificate into keychain
      run: |
        # Create a temporary keychain
        security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
        # Make the temporary keychain default
        security default-keychain -s build.keychain
        # Unlock the temporary keychain
        security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
        # Set keychain timeout to 1 hour for long builds
        security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
        # Add the certificate to the keychain
        security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -A
        # Allow codesign to access the keychain
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
      # run: |
      #   security create-keychain -p temp temp.keychain
      #   security default-keychain -s temp.keychain
      #   security unlock-keychain -p temp temp.keychain
      #   security import certificate.p12 -k temp.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
      #   security set-key-partition-list -S apple-tool:,apple: -s -k temp temp.keychain

    - name: Sign the app
      run: |
        mkdir -p ios/ShareMeal.xcodeproj
        cp profile.mobileprovision ios/ShareMeal.xcodeproj/embedded.mobileprovision
        codesign -f -s "Apple Distribution: Phudit Chuengjaoren (${{ secrets.TEAM_ID }})" --entitlements ios/ShareMeal.xcodeproj/ShareMeal.entitlements target/ios/release/ShareMeal.app
      working-directory: .

    - name: Archive to IPA
      run: |
        mkdir Payload
        mv YourApp.app Payload/
        zip -r YourApp.ipa Payload
      working-directory: .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ShareMeal.ipa
        path: ./ShareMeal.ipa
